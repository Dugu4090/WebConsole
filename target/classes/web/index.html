<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebConsole - Dashboard</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --mc-black: #000000;
            --mc-dark-blue: #0000AA;
            --mc-dark-green: #00AA00;
            --mc-dark-aqua: #00AAAA;
            --mc-dark-red: #AA0000;
            --mc-dark-purple: #AA00AA;
            --mc-gold: #FFAA00;
            --mc-gray: #AAAAAA;
            --mc-dark-gray: #555555;
            --mc-blue: #5555FF;
            --mc-green: #55FF55;
            --mc-aqua: #55FFFF;
            --mc-red: #FF5555;
            --mc-purple: #FF55FF;
            --mc-yellow: #FFFF55;
            --mc-white: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-connected { background: rgba(63, 185, 80, 0.15); color: var(--accent-green); }
        .status-disconnected { background: rgba(248, 81, 73, 0.15); color: var(--accent-red); }
        .status-connecting { background: rgba(86, 140, 253, 0.15); color: var(--accent-blue); }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }
        
        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .progress-fill { height: 100%; border-radius: 4px; }
        .progress-low { background: var(--accent-green); }
        .progress-medium { background: var(--accent-yellow); }
        .progress-high { background: var(--accent-red); }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
        }
        
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn:hover { background: var(--border-color); }
        .btn-primary { background: var(--accent-blue); color: white; border: none; }
        .btn-primary:hover { background: #4393e6; }
        
        .console-output {
            height: 400px;
            overflow-y: auto;
            background: #0d1117;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .console-line { padding: 2px 0; }
        .timestamp { color: #6e7681; margin-right: 8px; }
        .log-level { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 8px; min-width: 50px; text-align: center; }
        .log-info { background: rgba(56, 139, 253, 0.15); color: #58a6ff; }
        .log-warn { background: rgba(187, 128, 9, 0.15); color: #d29922; }
        .log-error { background: rgba(248, 81, 73, 0.15); color: #f85149; }
        .thread-name { color: #8b949e; font-size: 11px; }
        
        .mc-color-0 { color: var(--mc-black); }
        .mc-color-1 { color: var(--mc-dark-blue); }
        .mc-color-2 { color: var(--mc-dark-green); }
        .mc-color-3 { color: var(--mc-dark-aqua); }
        .mc-color-4 { color: var(--mc-dark-red); }
        .mc-color-5 { color: var(--mc-dark-purple); }
        .mc-color-6 { color: var(--mc-gold); }
        .mc-color-7 { color: var(--mc-gray); }
        .mc-color-8 { color: var(--mc-dark-gray); }
        .mc-color-9 { color: var(--mc-blue); }
        .mc-color-a { color: var(--mc-green); }
        .mc-color-b { color: var(--mc-aqua); }
        .mc-color-c { color: var(--mc-red); }
        .mc-color-d { color: var(--mc-purple); }
        .mc-color-e { color: var(--mc-yellow); }
        .mc-color-f { color: var(--mc-white); }
        .mc-bold { font-weight: bold; }
        
        .command-input-wrapper {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .command-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: monospace;
        }
        
        .command-input:focus { outline: none; border-color: var(--accent-blue); }
        
        .players-list { max-height: 250px; overflow-y: auto; }
        .player-item { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid var(--border-color); }
        .player-item:last-child { border-bottom: none; }
        .player-name { font-weight: 500; }
        .player-ping { color: var(--text-secondary); font-size: 12px; }
        
        .file-manager { padding: 20px; }
        .breadcrumb { display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 13px; }
        .breadcrumb-item { color: var(--accent-blue); cursor: pointer; }
        .breadcrumb-item:hover { text-decoration: underline; }
        .file-toolbar { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .file-table { width: 100%; border-collapse: collapse; }
        .file-table th, .file-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .file-table th { color: var(--text-secondary); font-size: 12px; text-transform: uppercase; }
        .file-table tr:hover { background: var(--bg-tertiary); }
        .file-row { cursor: pointer; }
        .file-folder { color: var(--mc-gold); }
        .file-actions { display: flex; gap: 6px; }
        .file-action-btn { padding: 4px 8px; background: transparent; border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-secondary); cursor: pointer; font-size: 11px; }
        .file-action-btn:hover { background: var(--bg-tertiary); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-terminal"></i> WebConsole Dashboard</h1>
            <span id="connection-badge" class="status-badge status-connecting">Connecting...</span>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Players</h3>
                <div class="stat-value" id="players-count">0 / 0</div>
                <div class="progress-bar"><div class="progress-fill progress-low" id="players-progress" style="width: 0%"></div></div>
            </div>
            <div class="stat-card">
                <h3>CPU</h3>
                <div class="stat-value" id="cpu-usage">0%</div>
                <div class="progress-bar"><div class="progress-fill progress-low" id="cpu-progress" style="width: 0%"></div></div>
            </div>
            <div class="stat-card">
                <h3>RAM</h3>
                <div class="stat-value" id="ram-usage">0 MB</div>
                <div class="progress-bar"><div class="progress-fill progress-low" id="ram-progress" style="width: 0%"></div></div>
            </div>
            <div class="stat-card">
                <h3>TPS</h3>
                <div class="stat-value" id="tps-value">20.0</div>
                <div class="progress-bar"><div class="progress-fill progress-low" id="tps-progress" style="width: 100%"></div></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title"><i class="fas fa-terminal"></i> Console</span>
                    <div>
                        <button class="btn" onclick="toggleConsole()"><i class="fas fa-eye"></i></button>
                        <button class="btn" onclick="clearConsole()"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="console-output" id="console-output">
                    <div class="console-line"><span class="timestamp">[System]</span> Connecting to server...</div>
                </div>
                <div class="command-input-wrapper">
                    <input type="text" class="command-input" id="command-input" placeholder="Type command...">
                    <button class="btn btn-primary" onclick="sendCommand()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div>
                <div class="panel" style="margin-bottom: 20px;">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-users"></i> Players</span>
                    </div>
                    <div class="players-list" id="players-list">
                        <div class="player-item" style="color: var(--text-secondary); justify-content: center;">No players online</div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <span class="panel-title"><i class="fas fa-folder-open"></i> Files</span>
                    </div>
                    <div class="file-manager">
                        <div class="breadcrumb" id="file-breadcrumb"><span class="breadcrumb-item" onclick="navigateToRoot()">/</span></div>
                        <div class="file-toolbar">
                            <button class="btn" onclick="goUp()"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn" onclick="refreshFiles()"><i class="fas fa-sync-alt"></i></button>
                            <button class="btn btn-primary" onclick="showCreateFolder()"><i class="fas fa-folder-plus"></i></button>
                            <button class="btn btn-primary" onclick="triggerUpload()"><i class="fas fa-upload"></i></button>
                            <input type="file" id="file-upload" style="display: none;" multiple onchange="handleUpload(this)">
                        </div>
                        <table class="file-table">
                            <thead><tr><th>Name</th><th>Size</th><th></th></tr></thead>
                            <tbody id="file-list"><tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let currentPath = '';
        let serverDirectory = '';
        let isLoggedIn = false;
        
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host);
            
            ws.onopen = function() {
                updateStatus('connecting', 'Connecting...');
            };
            
            ws.onmessage = function(event) {
                processMessage(JSON.parse(event.data));
            };
            
            ws.onclose = function() {
                updateStatus('disconnected', 'Disconnected');
                setTimeout(connect, 3000);
            };
        }
        
        function processMessage(data) {
            switch(data.status) {
                case 10: addConsoleLine(data.message, data.time); break;
                case 200: isLoggedIn = true; updateStatus('connected', 'Connected'); break;
                case 401: ws.send(JSON.stringify({command: 'LOGIN', params: ''})); break;
                case 1000: updatePlayers(data.connectedPlayers, data.maxPlayers); break;
                case 1001: updateCpu(data.usage); break;
                case 1002: updateRam(data.used, data.max); break;
                case 1003: updateTps(data.tps); break;
                case 2000: updateFileList(data); break;
                case 2001: editFile(data); break;
                case 200: case 2003: if(data.content) handleDownload(data); break;
                case 400: case 403: case 404: case 500: alert(data.message); break;
            }
        }
        
        function updateStatus(status, msg) {
            const badge = document.getElementById('connection-badge');
            badge.textContent = msg;
            badge.className = 'status-badge status-' + status;
        }
        
        function addConsoleLine(msg, time) {
            const output = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = 'console-line';
            
            let logClass = 'log-info';
            if (msg.includes('[ERROR]') || msg.includes('[SEVERE]')) logClass = 'log-error';
            else if (msg.includes('[WARN]')) logClass = 'log-warn';
            
            const threadMatch = msg.match(/\[([^\]]+)\/(\w+)\]/);
            let threadHtml = threadMatch ? '<span class="thread-name">[' + threadMatch[1] + ']</span> ' : '';
            
            line.innerHTML = '<span class="timestamp">' + (time || new Date().toLocaleTimeString()) + '</span>' +
                '<span class="log-level ' + logClass + '">' + getLogLevel(msg) + '</span>' +
                threadHtml + formatMcCodes(msg);
            
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function getLogLevel(msg) {
            if (msg.includes('[ERROR]') || msg.includes('[SEVERE]')) return 'ERROR';
            if (msg.includes('[WARN]')) return 'WARN';
            if (msg.includes('[DEBUG]')) return 'DEBUG';
            if (msg.includes('[INFO]')) return 'INFO';
            return '';
        }
        
        function formatMcCodes(msg) {
            msg = msg.replace(/</g, '&lt;');
            '0123456789abcdef'.split('').forEach((c, i) => {
                msg = msg.replace(new RegExp('ยง' + c, 'g'), '</span><span class="mc-color-' + c + '">');
            });
            'lmnor'.split('').forEach(f => {
                msg = msg.replace(new RegExp('ยง' + f, 'g'), '</span><span class="' + (f === 'l' ? 'mc-bold' : '') + '">');
            });
            return '<span class="mc-color-f">' + msg + '</span>';
        }
        
        function sendCommand() {
            const input = document.getElementById('command-input');
            const cmd = input.value.trim();
            if (!cmd || !ws) return;
            ws.send(JSON.stringify({command: 'EXEC', params: cmd}));
            input.value = '';
            addConsoleLine('[CONSOLE] ' + cmd, new Date().toLocaleTimeString());
        }
        
        document.getElementById('command-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendCommand();
        });
        
        function updatePlayers(online, max) {
            document.getElementById('players-count').textContent = online + ' / ' + max;
            const p = document.getElementById('players-progress');
            p.style.width = (online / max * 100) + '%';
            p.className = 'progress-fill ' + (online / max > 0.8 ? 'progress-high' : online / max > 0.5 ? 'progress-medium' : 'progress-low');
        }
        
        function updateCpu(usage) {
            document.getElementById('cpu-usage').textContent = Math.round(usage) + '%';
            const p = document.getElementById('cpu-progress');
            p.style.width = usage + '%';
            p.className = 'progress-fill ' + (usage > 80 ? 'progress-high' : usage > 50 ? 'progress-medium' : 'progress-low');
        }
        
        function updateRam(used, max) {
            document.getElementById('ram-usage').textContent = Math.round(used) + ' MB / ' + Math.round(max) + ' MB';
            const p = document.getElementById('ram-progress');
            p.style.width = (used / max * 100) + '%';
            p.className = 'progress-fill ' + (used / max > 0.8 ? 'progress-high' : used / max > 0.5 ? 'progress-medium' : 'progress-low');
        }
        
        function updateTps(tps) {
            document.getElementById('tps-value').textContent = tps.toFixed(1);
            const p = document.getElementById('tps-progress');
            p.style.width = (tps / 20 * 100) + '%';
            p.className = 'progress-fill ' + (tps < 10 ? 'progress-high' : tps < 15 ? 'progress-medium' : 'progress-low');
        }
        
        function loadFiles(path) {
            currentPath = path || serverDirectory || '';
            ws.send(JSON.stringify({command: 'FILE_LIST', params: currentPath}));
            updateBreadcrumb();
        }
        
        function updateFileList(data) {
            if (serverDirectory === '') serverDirectory = data.currentPath;
            currentPath = data.currentPath;
            updateBreadcrumb();
            
            const tbody = document.getElementById('file-list');
            const files = JSON.parse(data.files);
            
            if (files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-secondary);">Empty</td></tr>';
                return;
            }
            
            files.sort((a, b) => (a.is_folder === b.is_folder) ? a.name.localeCompare(b.name) : (a.is_folder ? -1 : 1));
            
            tbody.innerHTML = files.map(f => `
                <tr class="file-row" onclick="${f.is_folder ? 'loadFiles(\'' + (currentPath === serverDirectory ? currentPath + f.name : currentPath + '/' + f.name) + '\')' : 'viewFile(\'' + f.name + '\')'}">
                    <td><i class="fas ${f.is_folder ? 'fa-folder file-folder' : 'fa-file'}"></i> ${f.name}</td>
                    <td>${f.is_folder ? '-' : formatSize(f.size)}</td>
                    <td>
                        <div class="file-actions">
                            ${!f.is_folder ? '<button class="file-action-btn" onclick="event.stopPropagation(); downloadFile(\'' + f.name + '\')"><i class="fas fa-download"></i></button>' : ''}
                            <button class="file-action-btn" onclick="event.stopPropagation(); deleteFile(\'' + f.name + '\')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function formatSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function updateBreadcrumb() {
            const bc = document.getElementById('file-breadcrumb');
            if (currentPath === serverDirectory || !currentPath) {
                bc.innerHTML = '<span class="breadcrumb-item" onclick="navigateToRoot()">/</span>';
            } else {
                const rel = currentPath.replace(serverDirectory, '').replace(/^\//, '');
                const parts = rel.split('/');
                let path = serverDirectory;
                let html = '<span class="breadcrumb-item" onclick="navigateToRoot()">/</span>';
                parts.forEach(p => { path += '/' + p; html += '<span class="breadcrumb-item" onclick="loadFiles(\'' + path + '\')">' + p + '</span>/'; });
                bc.innerHTML = html;
            }
        }
        
        function navigateToRoot() { loadFiles(serverDirectory); }
        
        function goUp() {
            const last = currentPath.lastIndexOf('/');
            if (last > serverDirectory.length) loadFiles(currentPath.substring(0, last));
            else if (currentPath !== serverDirectory) loadFiles(serverDirectory);
        }
        
        function refreshFiles() { loadFiles(currentPath); }
        
        function viewFile(name) {
            const path = currentPath === serverDirectory ? currentPath + name : currentPath + '/' + name;
            ws.send(JSON.stringify({command: 'FILE_READ', params: JSON.stringify({path: path})}));
        }
        
        function editFile(data) {
            const c = JSON.parse(data.content);
            const newContent = prompt('Edit ' + c.name + ':', c.content);
            if (newContent !== null) {
                ws.send(JSON.stringify({command: 'FILE_WRITE', params: JSON.stringify({path: c.path, content: newContent})}));
            }
        }
        
        function downloadFile(name) {
            const path = currentPath === serverDirectory ? currentPath + name : currentPath + '/' + name;
            ws.send(JSON.stringify({command: 'FILE_DOWNLOAD', params: JSON.stringify({path: path})}));
        }
        
        function handleDownload(data) {
            const c = JSON.parse(data.content);
            const blob = new Blob([new Uint8Array(atob(c.content).split('').map(c => c.charCodeAt(0)))]);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = c.filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        function deleteFile(name) {
            if (confirm('Delete ' + name + '?')) {
                const path = currentPath === serverDirectory ? currentPath + name : currentPath + '/' + name;
                ws.send(JSON.stringify({command: 'FILE_DELETE', params: JSON.stringify({path: path})}));
            }
        }
        
        function showCreateFolder() {
            const name = prompt('Folder name:');
            if (name) {
                const path = currentPath === serverDirectory ? currentPath + name : currentPath + '/' + name;
                ws.send(JSON.stringify({command: 'FILE_CREATE_FOLDER', params: JSON.stringify({path: path})}));
            }
        }
        
        function triggerUpload() { document.getElementById('file-upload').click(); }
        
        function handleUpload(input) {
            Array.from(input.files).forEach(file => {
                const r = new FileReader();
                r.onload = function(e) {
                    const path = currentPath === serverDirectory ? currentPath + file.name : currentPath + '/' + file.name;
                    ws.send(JSON.stringify({command: 'FILE_WRITE', params: JSON.stringify({path: path, content: e.target.result.split(',')[1]})}));
                    if (file === input.files[input.files.length - 1]) refreshFiles();
                };
                r.readAsDataURL(file);
            });
        }
        
        function toggleConsole() {
            const o = document.getElementById('console-output');
            o.style.display = o.style.display === 'none' ? 'block' : 'none';
        }
        
        function clearConsole() { document.getElementById('console-output').innerHTML = ''; }
        
        connect();
        loadFiles('');
    </script>
</body>
</html>
